From 97f4ae47c46973418409ccdac818407c59bcd730 Mon Sep 17 00:00:00 2001
From: Tomasz Andrzejak <andreiltd@gmail.com>
Date: Fri, 8 Aug 2025 13:27:33 +0200
Subject: [PATCH] feat: add no_std support

---
 src/lib.rs | 98 ++++++++++++++++++++++++++++--------------------------
 1 file changed, 50 insertions(+), 48 deletions(-)

diff --git a/src/lib.rs b/src/lib.rs
index e5f31c1..323dc06 100644
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -7,6 +7,7 @@
 // option. This file may not be copied, modified, or distributed
 // except according to those terms.
 
+#![no_std]
 //! FFI bindings for `encoding_rs::mem`.
 //!
 //! _Note:_ "Latin1" in this module refers to the Unicode range from U+0000 to
@@ -28,7 +29,7 @@ use encoding_rs::mem::Latin1Bidi;
 /// still has to be non-`NULL`.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_is_ascii(buffer: *const u8, len: usize) -> bool {
-    encoding_rs::mem::is_ascii(::std::slice::from_raw_parts(buffer, len))
+    encoding_rs::mem::is_ascii(::core::slice::from_raw_parts(buffer, len))
 }
 
 /// Checks whether the buffer is all-Basic Latin (i.e. UTF-16 representing
@@ -44,7 +45,7 @@ pub unsafe extern "C" fn encoding_mem_is_ascii(buffer: *const u8, len: usize) ->
 /// still has to be non-`NULL` and aligned.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_is_basic_latin(buffer: *const u16, len: usize) -> bool {
-    encoding_rs::mem::is_basic_latin(::std::slice::from_raw_parts(buffer, len))
+    encoding_rs::mem::is_basic_latin(::core::slice::from_raw_parts(buffer, len))
 }
 
 /// Checks whether the buffer is valid UTF-8 representing only code points
@@ -60,7 +61,7 @@ pub unsafe extern "C" fn encoding_mem_is_basic_latin(buffer: *const u16, len: us
 /// still has to be non-`NULL`.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_is_utf8_latin1(buffer: *const u8, len: usize) -> bool {
-    encoding_rs::mem::is_utf8_latin1(::std::slice::from_raw_parts(buffer, len))
+    encoding_rs::mem::is_utf8_latin1(::core::slice::from_raw_parts(buffer, len))
 }
 
 /// Checks whether the buffer represents only code points less than or equal
@@ -77,8 +78,8 @@ pub unsafe extern "C" fn encoding_mem_is_utf8_latin1(buffer: *const u8, len: usi
 /// still has to be non-`NULL`.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_is_str_latin1(buffer: *const u8, len: usize) -> bool {
-    encoding_rs::mem::is_str_latin1(::std::str::from_utf8_unchecked(
-        ::std::slice::from_raw_parts(buffer, len),
+    encoding_rs::mem::is_str_latin1(::core::str::from_utf8_unchecked(
+        ::core::slice::from_raw_parts(buffer, len),
     ))
 }
 
@@ -95,7 +96,7 @@ pub unsafe extern "C" fn encoding_mem_is_str_latin1(buffer: *const u8, len: usiz
 /// still has to be non-`NULL` and aligned.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_is_utf16_latin1(buffer: *const u16, len: usize) -> bool {
-    encoding_rs::mem::is_utf16_latin1(::std::slice::from_raw_parts(buffer, len))
+    encoding_rs::mem::is_utf16_latin1(::core::slice::from_raw_parts(buffer, len))
 }
 
 /// Checks whether a potentially-invalid UTF-8 buffer contains code points
@@ -122,7 +123,7 @@ pub unsafe extern "C" fn encoding_mem_is_utf16_latin1(buffer: *const u16, len: u
 /// still has to be non-`NULL`.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_is_utf8_bidi(buffer: *const u8, len: usize) -> bool {
-    encoding_rs::mem::is_utf8_bidi(::std::slice::from_raw_parts(buffer, len))
+    encoding_rs::mem::is_utf8_bidi(::core::slice::from_raw_parts(buffer, len))
 }
 
 /// Checks whether a valid UTF-8 buffer contains code points that trigger
@@ -146,8 +147,8 @@ pub unsafe extern "C" fn encoding_mem_is_utf8_bidi(buffer: *const u8, len: usize
 /// still has to be non-`NULL`.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_is_str_bidi(buffer: *const u8, len: usize) -> bool {
-    encoding_rs::mem::is_str_bidi(::std::str::from_utf8_unchecked(
-        ::std::slice::from_raw_parts(buffer, len),
+    encoding_rs::mem::is_str_bidi(::core::str::from_utf8_unchecked(
+        ::core::slice::from_raw_parts(buffer, len),
     ))
 }
 
@@ -176,7 +177,7 @@ pub unsafe extern "C" fn encoding_mem_is_str_bidi(buffer: *const u8, len: usize)
 /// still has to be non-`NULL` and aligned.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_is_utf16_bidi(buffer: *const u16, len: usize) -> bool {
-    encoding_rs::mem::is_utf16_bidi(::std::slice::from_raw_parts(buffer, len))
+    encoding_rs::mem::is_utf16_bidi(::core::slice::from_raw_parts(buffer, len))
 }
 
 /// Checks whether a scalar value triggers right-to-left processing.
@@ -195,8 +196,8 @@ pub unsafe extern "C" fn encoding_mem_is_utf16_bidi(buffer: *const u16, len: usi
 ///
 /// Undefined behavior ensues if `c` is not a valid Unicode Scalar Value.
 #[no_mangle]
-pub unsafe extern "C" fn encoding_mem_is_char_bidi(c: char) -> bool {
-    encoding_rs::mem::is_char_bidi(c)
+pub unsafe extern "C" fn encoding_mem_is_char_bidi(c: u32) -> bool {
+    core::char::from_u32(c).map_or(false, |ch| encoding_rs::mem::is_char_bidi(ch))
 }
 
 /// Checks whether a UTF-16 code unit triggers right-to-left processing.
@@ -241,7 +242,7 @@ pub unsafe extern "C" fn encoding_mem_check_utf8_for_latin1_and_bidi(
     buffer: *const u8,
     len: usize,
 ) -> Latin1Bidi {
-    encoding_rs::mem::check_utf8_for_latin1_and_bidi(::std::slice::from_raw_parts(buffer, len))
+    encoding_rs::mem::check_utf8_for_latin1_and_bidi(::core::slice::from_raw_parts(buffer, len))
 }
 
 /// Checks whether a valid UTF-8 buffer contains code points
@@ -264,8 +265,8 @@ pub unsafe extern "C" fn encoding_mem_check_str_for_latin1_and_bidi(
     buffer: *const u8,
     len: usize,
 ) -> Latin1Bidi {
-    encoding_rs::mem::check_str_for_latin1_and_bidi(::std::str::from_utf8_unchecked(
-        ::std::slice::from_raw_parts(buffer, len),
+    encoding_rs::mem::check_str_for_latin1_and_bidi(::core::str::from_utf8_unchecked(
+        ::core::slice::from_raw_parts(buffer, len),
     ))
 }
 
@@ -288,7 +289,7 @@ pub unsafe extern "C" fn encoding_mem_check_utf16_for_latin1_and_bidi(
     buffer: *const u16,
     len: usize,
 ) -> Latin1Bidi {
-    encoding_rs::mem::check_utf16_for_latin1_and_bidi(::std::slice::from_raw_parts(buffer, len))
+    encoding_rs::mem::check_utf16_for_latin1_and_bidi(::core::slice::from_raw_parts(buffer, len))
 }
 
 /// Converts potentially-invalid UTF-8 to valid UTF-16 with errors replaced
@@ -318,8 +319,8 @@ pub unsafe extern "C" fn encoding_mem_convert_utf8_to_utf16(
     dst_len: usize,
 ) -> usize {
     encoding_rs::mem::convert_utf8_to_utf16(
-        ::std::slice::from_raw_parts(src, src_len),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
+        ::core::slice::from_raw_parts(src, src_len),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
     )
 }
 
@@ -350,8 +351,8 @@ pub unsafe extern "C" fn encoding_mem_convert_str_to_utf16(
     dst_len: usize,
 ) -> usize {
     encoding_rs::mem::convert_str_to_utf16(
-        ::std::str::from_utf8_unchecked(::std::slice::from_raw_parts(src, src_len)),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
+        ::core::str::from_utf8_unchecked(::core::slice::from_raw_parts(src, src_len)),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
     )
 }
 
@@ -383,9 +384,10 @@ pub unsafe extern "C" fn encoding_mem_convert_utf8_to_utf16_without_replacement(
     dst_len: usize,
 ) -> usize {
     encoding_rs::mem::convert_utf8_to_utf16_without_replacement(
-        ::std::slice::from_raw_parts(src, src_len),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
-    ).unwrap_or(::std::usize::MAX)
+        ::core::slice::from_raw_parts(src, src_len),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
+    )
+    .unwrap_or(::core::usize::MAX)
 }
 
 /// Converts potentially-invalid UTF-16 to valid UTF-8 with errors replaced
@@ -430,8 +432,8 @@ pub unsafe extern "C" fn encoding_mem_convert_utf16_to_utf8_partial(
     dst_len: *mut usize,
 ) {
     let (read, written) = encoding_rs::mem::convert_utf16_to_utf8_partial(
-        ::std::slice::from_raw_parts(src, *src_len),
-        ::std::slice::from_raw_parts_mut(dst, *dst_len),
+        ::core::slice::from_raw_parts(src, *src_len),
+        ::core::slice::from_raw_parts_mut(dst, *dst_len),
     );
     *src_len = read;
     *dst_len = written;
@@ -470,8 +472,8 @@ pub unsafe extern "C" fn encoding_mem_convert_utf16_to_utf8(
     dst_len: usize,
 ) -> usize {
     encoding_rs::mem::convert_utf16_to_utf8(
-        ::std::slice::from_raw_parts(src, src_len),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
+        ::core::slice::from_raw_parts(src, src_len),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
     )
 }
 
@@ -502,8 +504,8 @@ pub unsafe extern "C" fn encoding_mem_convert_latin1_to_utf16(
     dst_len: usize,
 ) {
     encoding_rs::mem::convert_latin1_to_utf16(
-        ::std::slice::from_raw_parts(src, src_len),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
+        ::core::slice::from_raw_parts(src, src_len),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
     );
 }
 
@@ -537,8 +539,8 @@ pub unsafe extern "C" fn encoding_mem_convert_latin1_to_utf8_partial(
     dst_len: *mut usize,
 ) {
     let (read, written) = encoding_rs::mem::convert_latin1_to_utf8_partial(
-        ::std::slice::from_raw_parts(src, *src_len),
-        ::std::slice::from_raw_parts_mut(dst, *dst_len),
+        ::core::slice::from_raw_parts(src, *src_len),
+        ::core::slice::from_raw_parts_mut(dst, *dst_len),
     );
     *src_len = read;
     *dst_len = written;
@@ -578,8 +580,8 @@ pub unsafe extern "C" fn encoding_mem_convert_latin1_to_utf8(
     dst_len: usize,
 ) -> usize {
     encoding_rs::mem::convert_latin1_to_utf8(
-        ::std::slice::from_raw_parts(src, src_len),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
+        ::core::slice::from_raw_parts(src, src_len),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
     )
 }
 
@@ -622,8 +624,8 @@ pub unsafe extern "C" fn encoding_mem_convert_utf8_to_latin1_lossy(
     dst_len: usize,
 ) -> usize {
     encoding_rs::mem::convert_utf8_to_latin1_lossy(
-        ::std::slice::from_raw_parts(src, src_len),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
+        ::core::slice::from_raw_parts(src, src_len),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
     )
 }
 
@@ -666,8 +668,8 @@ pub unsafe extern "C" fn encoding_mem_convert_utf16_to_latin1_lossy(
     dst_len: usize,
 ) {
     encoding_rs::mem::convert_utf16_to_latin1_lossy(
-        ::std::slice::from_raw_parts(src, src_len),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
+        ::core::slice::from_raw_parts(src, src_len),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
     );
 }
 
@@ -681,7 +683,7 @@ pub unsafe extern "C" fn encoding_mem_convert_utf16_to_latin1_lossy(
 /// still has to be non-`NULL` and aligned.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_utf16_valid_up_to(buffer: *const u16, len: usize) -> usize {
-    encoding_rs::mem::utf16_valid_up_to(::std::slice::from_raw_parts(buffer, len))
+    encoding_rs::mem::utf16_valid_up_to(::core::slice::from_raw_parts(buffer, len))
 }
 
 /// Returns the index of first byte that starts an invalid byte
@@ -695,7 +697,7 @@ pub unsafe extern "C" fn encoding_mem_utf16_valid_up_to(buffer: *const u16, len:
 /// still has to be non-`NULL` and aligned.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_utf8_latin1_up_to(buffer: *const u8, len: usize) -> usize {
-    encoding_rs::mem::utf8_latin1_up_to(::std::slice::from_raw_parts(buffer, len))
+    encoding_rs::mem::utf8_latin1_up_to(::core::slice::from_raw_parts(buffer, len))
 }
 
 /// Returns the index of first byte that starts a non-Latin1 byte
@@ -709,8 +711,8 @@ pub unsafe extern "C" fn encoding_mem_utf8_latin1_up_to(buffer: *const u8, len:
 /// and aligned.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_str_latin1_up_to(buffer: *const u8, len: usize) -> usize {
-    encoding_rs::mem::str_latin1_up_to(::std::str::from_utf8_unchecked(
-        ::std::slice::from_raw_parts(buffer, len),
+    encoding_rs::mem::str_latin1_up_to(::core::str::from_utf8_unchecked(
+        ::core::slice::from_raw_parts(buffer, len),
     ))
 }
 
@@ -723,7 +725,7 @@ pub unsafe extern "C" fn encoding_mem_str_latin1_up_to(buffer: *const u8, len: u
 /// still has to be non-`NULL` and aligned.)
 #[no_mangle]
 pub unsafe extern "C" fn encoding_mem_ensure_utf16_validity(buffer: *mut u16, len: usize) {
-    encoding_rs::mem::ensure_utf16_validity(::std::slice::from_raw_parts_mut(buffer, len));
+    encoding_rs::mem::ensure_utf16_validity(::core::slice::from_raw_parts_mut(buffer, len));
 }
 
 /// Copies ASCII from source to destination up to the first non-ASCII byte
@@ -753,8 +755,8 @@ pub unsafe extern "C" fn encoding_mem_copy_ascii_to_ascii(
     dst_len: usize,
 ) -> usize {
     encoding_rs::mem::copy_ascii_to_ascii(
-        ::std::slice::from_raw_parts(src, src_len),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
+        ::core::slice::from_raw_parts(src, src_len),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
     )
 }
 
@@ -786,8 +788,8 @@ pub unsafe extern "C" fn encoding_mem_copy_ascii_to_basic_latin(
     dst_len: usize,
 ) -> usize {
     encoding_rs::mem::copy_ascii_to_basic_latin(
-        ::std::slice::from_raw_parts(src, src_len),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
+        ::core::slice::from_raw_parts(src, src_len),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
     )
 }
 
@@ -819,7 +821,7 @@ pub unsafe extern "C" fn encoding_mem_copy_basic_latin_to_ascii(
     dst_len: usize,
 ) -> usize {
     encoding_rs::mem::copy_basic_latin_to_ascii(
-        ::std::slice::from_raw_parts(src, src_len),
-        ::std::slice::from_raw_parts_mut(dst, dst_len),
+        ::core::slice::from_raw_parts(src, src_len),
+        ::core::slice::from_raw_parts_mut(dst, dst_len),
     )
 }
-- 
2.48.1

